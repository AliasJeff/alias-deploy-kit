<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LLM æ¨ç†è¯„æµ‹å¯è§†åŒ–çœ‹æ¿ v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: {
                50: "#f8fafc",
                100: "#f1f5f9",
                200: "#e2e8f0",
                300: "#cbd5e1",
                400: "#94a3b8",
                500: "#64748b",
                600: "#475569",
                700: "#334155",
                800: "#1e293b",
                900: "#0f172a",
              },
            },
          },
        },
      };
    </script>
    <style>
      /* æ»šåŠ¨æ¡ç¾åŒ– */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* é¢„è§ˆåŒºèƒŒæ™¯ç½‘æ ¼çº¹ç† */
      .preview-pattern {
        background-color: #ffffff;
        background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
        background-size: 20px 20px;
      }

      .fade-in {
        animation: fadeIn 0.4s ease-out forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* UI ç»Ÿè®¡å¾½ç« æ ·å¼ */
      .stat-badge {
        @apply flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-medium border transition-colors cursor-help select-none;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800 min-h-screen font-sans">
    <header
      class="bg-white/90 backdrop-blur sticky top-0 z-50 border-b border-slate-200 shadow-sm"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div
          class="flex flex-col md:flex-row justify-between items-center py-3 gap-4"
        >
          <div class="flex items-center gap-3">
            <div
              class="bg-indigo-600 text-white p-2 rounded-lg shadow-indigo-200 shadow-md"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                ></path>
              </svg>
            </div>
            <div>
              <h1 class="text-xl font-bold text-slate-800 tracking-tight">
                è¯„æµ‹å¯è§†åŒ–çœ‹æ¿
                <span class="text-xs font-normal text-slate-500 ml-1"
                  >v1.0</span
                >
              </h1>
            </div>
          </div>

          <div class="flex items-center gap-4">
            <span id="file-status" class="text-xs text-slate-400 hidden"></span>
            <label
              class="cursor-pointer group relative overflow-hidden bg-slate-900 hover:bg-slate-800 text-white px-5 py-2.5 rounded-full font-medium transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2"
            >
              <svg
                class="w-5 h-5 group-hover:scale-110 transition-transform"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"
                ></path>
              </svg>
              <span>åŠ è½½ JSON æ–‡ä»¶å¤¹</span>
              <input
                type="file"
                id="dir-input"
                webkitdirectory
                directory
                multiple
                class="absolute inset-0 opacity-0 cursor-pointer"
              />
            </label>
          </div>
        </div>

        <div
          id="file-list"
          class="flex flex-nowrap overflow-x-auto gap-2 py-3 hidden scrollbar-hide border-t border-slate-100"
        ></div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-[80vh]">
      <div
        id="empty-state"
        class="flex flex-col items-center justify-center py-20 fade-in text-center"
      >
        <div
          class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-6 border border-slate-200"
        >
          <svg
            class="w-10 h-10 text-slate-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
            ></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-slate-700 mb-2">å‡†å¤‡å°±ç»ª</h2>
        <p class="text-slate-500 max-w-md">
          è¯·ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®é€‰æ‹©è¯„æµ‹ç»“æœæ–‡ä»¶å¤¹ã€‚<br />é¡µé¢å°†è‡ªåŠ¨è§£ææ‰€æœ‰ JSON
          æ–‡ä»¶ã€‚
        </p>
      </div>

      <div id="dashboard" class="hidden space-y-8 fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div
            class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 flex flex-col justify-between"
          >
            <div>
              <h2
                class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-l-4 border-indigo-500 pl-2"
              >
                Meta Information
              </h2>
              <div class="space-y-3">
                <div
                  class="flex justify-between items-center border-b border-slate-50 pb-2"
                >
                  <span class="text-sm text-slate-500">Model</span>
                  <span class="font-bold text-slate-800 text-lg" id="meta-model"
                    >-</span
                  >
                </div>
                <div
                  class="flex justify-between items-center border-b border-slate-50 pb-2"
                >
                  <span class="text-sm text-slate-500">Size / Params</span>
                  <span class="text-sm font-mono text-slate-700" id="meta-size"
                    >-</span
                  >
                </div>
                <div
                  class="flex justify-between items-center border-b border-slate-50 pb-2"
                >
                  <span class="text-sm text-slate-500">Quantization</span>
                  <span
                    class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600"
                    id="meta-quant"
                    >-</span
                  >
                </div>
                <div class="flex justify-between items-center pt-1">
                  <span class="text-sm text-slate-500">Time</span>
                  <span class="text-xs font-mono text-slate-400" id="meta-time"
                    >-</span
                  >
                </div>
              </div>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-100">
              <p class="text-xs text-slate-400 mb-2">Inference Config</p>
              <div id="meta-config" class="flex flex-wrap gap-2"></div>
            </div>
          </div>

          <div
            class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm border border-slate-200"
          >
            <div class="flex justify-between items-center mb-6">
              <h2
                class="text-xs font-bold text-slate-400 uppercase tracking-wider border-l-4 border-emerald-500 pl-2"
              >
                Performance Summary
              </h2>
              <div
                class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100"
              >
                <span class="text-xs text-slate-500 font-medium"
                  >Valid Render Rate</span
                >
                <span
                  class="text-lg font-bold transition-colors"
                  id="success-rate"
                  >0%</span
                >
              </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
              <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                <div class="text-2xl font-bold text-slate-800" id="sum-req">
                  0
                </div>
                <div class="text-xs text-slate-500 mt-1">Total Requests</div>
              </div>
              <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                <div
                  class="text-2xl font-bold text-indigo-600"
                  id="sum-latency"
                >
                  0s
                </div>
                <div class="text-xs text-slate-500 mt-1">Avg Latency</div>
              </div>
              <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                <div class="text-2xl font-bold text-emerald-600" id="sum-tps">
                  0
                </div>
                <div class="text-xs text-slate-500 mt-1">Global TPS</div>
              </div>
              <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                <div class="text-2xl font-bold text-purple-600" id="sum-mem">
                  0
                </div>
                <div class="text-xs text-slate-500 mt-1">RAM (MB)</div>
              </div>
            </div>
            <div class="flex justify-between mt-6 text-xs text-slate-400 px-2">
              <span
                >Total Duration:
                <strong class="text-slate-600" id="sum-duration"
                  >-</strong
                ></span
              >
              <span
                >RPS:
                <strong class="text-slate-600" id="sum-rps">-</strong></span
              >
            </div>
          </div>
        </div>

        <div>
          <div class="flex items-center gap-3 mb-5 px-1">
            <h2 class="text-xl font-bold text-slate-800">è¯¦ç»†è¯„æµ‹å¡ç‰‡</h2>
            <span
              class="bg-slate-200 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full"
              id="details-count"
              >0</span
            >
          </div>

          <div id="details-container" class="space-y-8"></div>
        </div>
      </div>
    </main>

    <script>
      // --- å…¨å±€å˜é‡ä¸ DOM å¼•ç”¨ ---
      let loadedFiles = {};
      const dirInput = document.getElementById("dir-input");
      const fileList = document.getElementById("file-list");
      const emptyState = document.getElementById("empty-state");
      const dashboard = document.getElementById("dashboard");

      // --- 1. æ–‡ä»¶è¯»å–é€»è¾‘ ---
      dirInput.addEventListener("change", async (e) => {
        const files = Array.from(e.target.files).filter((f) =>
          f.name.toLowerCase().endsWith(".json")
        );
        if (files.length === 0) {
          alert("æœªæ‰¾åˆ° JSON æ–‡ä»¶ï¼Œè¯·ç¡®è®¤æ–‡ä»¶å¤¹å†…å®¹ã€‚");
          return;
        }

        // é‡ç½®çŠ¶æ€
        loadedFiles = {};
        fileList.innerHTML = "";
        fileList.classList.remove("hidden");
        document.getElementById(
          "file-status"
        ).innerText = `å·²åŠ è½½ ${files.length} ä¸ªæ–‡ä»¶`;
        document.getElementById("file-status").classList.remove("hidden");

        // è¯»å–æ‰€æœ‰æ–‡ä»¶
        for (const file of files) {
          try {
            const text = await readFile(file);
            const json = JSON.parse(text);
            loadedFiles[file.name] = json;

            // åˆ›å»ºå¯¼èˆªæŒ‰é’®
            const btn = document.createElement("button");
            btn.className = `whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium border transition-all duration-200 flex-shrink-0 bg-white text-slate-600 border-slate-200 hover:border-indigo-400 hover:text-indigo-600`;
            btn.textContent = file.name;
            btn.onclick = () => switchFile(file.name, btn);
            fileList.appendChild(btn);
          } catch (err) {
            console.error(`è§£æé”™è¯¯ ${file.name}:`, err);
          }
        }
        // è‡ªåŠ¨ç‚¹å‡»ç¬¬ä¸€ä¸ªæ–‡ä»¶
        if (fileList.firstChild) fileList.firstChild.click();
      });

      function readFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsText(file);
        });
      }

      // --- 2. é¡µé¢åˆ‡æ¢é€»è¾‘ ---
      function switchFile(filename, activeBtn) {
        // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
        Array.from(fileList.children).forEach((btn) => {
          btn.className = `whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium border transition-all duration-200 flex-shrink-0 bg-white text-slate-600 border-slate-200 hover:border-indigo-400 hover:text-indigo-600 opacity-70`;
        });
        // æ¿€æ´»å½“å‰æŒ‰é’®
        activeBtn.className = `whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium border transition-all duration-200 flex-shrink-0 bg-slate-800 text-white border-slate-800 shadow-md transform scale-105`;

        const data = loadedFiles[filename];
        if (data) {
          emptyState.classList.add("hidden");
          dashboard.classList.remove("hidden");
          renderDashboard(data);
        }
      }

      // --- 3. æ¸²æŸ“æ ¸å¿ƒé€»è¾‘ ---
      function renderDashboard(data) {
        renderMeta(data.meta);
        const successRate = renderDetails(data.details);
        renderSummary(data.summary, successRate);
      }

      function renderMeta(meta) {
        if (!meta) return;
        const m = meta.model || {};
        const c = meta.config || {};

        document.getElementById("meta-model").textContent =
          m.model_name || "Unknown";
        document.getElementById("meta-size").textContent = `${(
          m.model_size_gb || 0
        ).toFixed(2)} GB / ${(m.param_count / 1e9).toFixed(2)}B`;
        document.getElementById("meta-quant").textContent =
          m.quantization || "None";
        document.getElementById("meta-time").textContent = meta.timestamp
          ? new Date(meta.timestamp).toLocaleString()
          : "-";

        const configBox = document.getElementById("meta-config");
        configBox.innerHTML = "";
        Object.entries(c).forEach(([k, v]) => {
          configBox.innerHTML += `<span class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs border border-slate-200 font-mono">${k}: ${v}</span>`;
        });
      }

      function renderSummary(summary, rate) {
        if (!summary) return;
        document.getElementById("sum-req").textContent = summary.total_requests;
        document.getElementById("sum-latency").textContent =
          summary.avg_latency?.toFixed(4) + "s";
        document.getElementById("sum-tps").textContent =
          summary.global_tps?.toFixed(2);
        document.getElementById("sum-mem").textContent =
          summary.final_memory?.ram_usage_mb?.toFixed(0) || "-";
        document.getElementById("sum-duration").textContent =
          summary.total_duration?.toFixed(2) + "s";
        document.getElementById("sum-rps").textContent = summary.rps;

        const rateEl = document.getElementById("success-rate");
        rateEl.textContent = rate + "%";
        rateEl.className = `text-lg font-bold transition-colors ${
          rate >= 90
            ? "text-emerald-600"
            : rate >= 50
            ? "text-amber-500"
            : "text-red-500"
        }`;
      }

      function renderDetails(details) {
        const container = document.getElementById("details-container");
        container.innerHTML = "";
        document.getElementById("details-count").textContent = details
          ? details.length
          : 0;

        if (!details || details.length === 0) return 0;

        let successCount = 0;

        details.forEach((item) => {
          // A. å‰ç«¯ Token è®¡ç®— (ä½¿ç”¨ JS æ­£åˆ™ä¼°ç®—)
          // ç®—æ³•ï¼šåŒ¹é… [è¿ç»­çš„è‹±æ–‡å•è¯] æˆ– [å•ä¸ªéç©ºç™½éå•è¯å­—ç¬¦(å¦‚ä¸­æ–‡ã€æ ‡ç‚¹)]
          const userTokens = calcTokens(item.prompt.user);
          const sysTokens = calcTokens(item.prompt.system);
          const outputTokens = calcTokens(item.output);

          // B. æå– HTML å¹¶ä¸¥æ ¼éªŒè¯ (æ£€æŸ¥æ˜¯å¦é—­åˆ)
          const { html, isValid, truncated } = extractAndValidateHtml(
            item.output
          );
          if (isValid) successCount++;

          // C. ç»Ÿè®¡ UI å…ƒç´  (ä»…å½“æœ‰ HTML å†…å®¹æ—¶)
          const uiStats = html ? analyzeUiElements(html) : null;
          const uiStatsHtml = uiStats
            ? `
                    <div class="flex flex-wrap gap-2 py-2 border-b border-slate-100 bg-slate-50/50 px-5 select-none">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider self-center mr-1">UI Elements:</span>
                        <span class="stat-badge bg-blue-50 text-blue-700 border-blue-200" title="Buttons & Submits">ğŸ–±ï¸ Btn: ${uiStats.buttons}</span>
                        <span class="stat-badge bg-indigo-50 text-indigo-700 border-indigo-200" title="Inputs / Textareas / Selects">âŒ¨ï¸ Inp: ${uiStats.inputs}</span>
                        <span class="stat-badge bg-cyan-50 text-cyan-700 border-cyan-200" title="Hyperlinks">ğŸ”— Link: ${uiStats.links}</span>
                        <span class="stat-badge bg-purple-50 text-purple-700 border-purple-200" title="Images">ğŸ–¼ï¸ Img: ${uiStats.images}</span>
                        <span class="stat-badge bg-slate-50 text-slate-600 border-slate-200" title="Div Containers">ğŸ“¦ Div: ${uiStats.divs}</span>
                    </div>
                `
            : "";

          // D. çŠ¶æ€å¾½ç«  (æ ¹æ® isValid æ˜¾ç¤º âœ… æˆ– âŒ)
          const statusBadge = isValid
            ? `<span class="flex items-center gap-1.5 bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full text-xs font-bold border border-emerald-200"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> âœ… Render Success</span>`
            : `<span class="flex items-center gap-1.5 bg-red-50 text-red-700 px-3 py-1 rounded-full text-xs font-bold border border-red-200"><span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> âŒ ${
                truncated ? "Truncated" : "Failed"
              }</span>`;

          // E. æ„å»ºå¡ç‰‡ DOM
          const card = document.createElement("div");
          card.className =
            "bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-shadow duration-300";

          card.innerHTML = `
                    <div class="grid grid-cols-1 xl:grid-cols-2 divide-y xl:divide-y-0 xl:divide-x divide-slate-100">
                        <div class="flex flex-col h-full min-h-[500px]">
                            <div class="px-5 py-3 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                <span class="bg-white border border-slate-200 text-slate-500 font-mono text-xs px-2 py-1 rounded">ID: ${
                                  item.id
                                }</span>
                                <div class="flex gap-3 text-xs text-slate-500 font-mono">
                                    <span title="User Input Tokens (JS Est.)">User: <b class="text-slate-700">${userTokens}</b></span>
                                    <span title="System Input Tokens (JS Est.)">Sys: <b class="text-slate-700">${sysTokens}</b></span>
                                    <span title="Output Tokens (JS Est.)">Out: <b class="text-indigo-600">${outputTokens}</b></span>
                                </div>
                            </div>
                            
                            <div class="p-5 space-y-4 flex-1 overflow-hidden flex flex-col">
                                <div>
                                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">User Prompt</h3>
                                    <div class="bg-indigo-50/30 border border-indigo-100 rounded-lg p-3 text-sm text-slate-700 max-h-32 overflow-y-auto leading-relaxed">
                                        ${escapeHtml(item.prompt.user)}
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">System Prompt</h3>
                                    <div class="bg-slate-50 border border-slate-100 rounded-lg p-3 text-xs text-slate-500 font-mono max-h-24 overflow-y-auto">
                                        ${escapeHtml(item.prompt.system)}
                                    </div>
                                </div>

                                <div class="flex-1 flex flex-col min-h-0">
                                    <details class="group flex flex-col h-full">
                                        <summary class="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-400 hover:text-indigo-600 transition-colors select-none mb-2">
                                            <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                            View Raw Output (Source Code)
                                        </summary>
                                        <div class="bg-slate-900 text-slate-300 p-3 rounded-lg text-xs font-mono overflow-auto whitespace-pre-wrap border border-slate-800 shadow-inner max-h-[200px] xl:max-h-full">
${escapeHtml(item.output)}
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col min-h-[500px] bg-slate-50/30">
                            <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-white h-[53px]">
                                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">HTML Preview</h3>
                                ${statusBadge}
                            </div>
                            
                            ${uiStatsHtml}

                            <div class="flex-1 p-4 flex flex-col">
                                <div class="w-full flex-1 bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden relative preview-pattern group">
                                    ${
                                      html
                                        ? `<iframe class="w-full h-full border-0" sandbox="allow-scripts" srcdoc="${escapeAttribute(
                                            html
                                          )}"></iframe>`
                                        : `<div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 p-8 text-center">
                                            <svg class="w-10 h-10 mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="text-sm font-medium">æ— æœ‰æ•ˆå†…å®¹</span>
                                           </div>`
                                    }
                                    
                                    ${
                                      !isValid && html
                                        ? `
                                        <div class="absolute top-0 inset-x-0 bg-amber-500/10 text-amber-600 text-[10px] font-bold text-center py-1 border-b border-amber-200 backdrop-blur-sm">
                                            âš ï¸ Warning: Code Truncated / Incomplete
                                        </div>
                                    `
                                        : ""
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
          container.appendChild(card);
        });

        return details.length > 0
          ? ((successCount / details.length) * 100).toFixed(1)
          : 0;
      }

      // --- å·¥å…·å‡½æ•° ---

      // 1. JS Token è®¡æ•°å™¨
      function calcTokens(text) {
        if (!text) return 0;
        // æ­£åˆ™é€»è¾‘ï¼šåŒ¹é… [è¿ç»­çš„å­—æ¯æ•°å­—(å•è¯)] æˆ– [å•ä¸ªéç©ºç™½éå­—æ¯æ•°å­—(æ ‡ç‚¹/ä¸­æ–‡)]
        // ä¾‹å¦‚ "Hello world." -> "Hello", "world", "." (3)
        // "ä½ å¥½" -> "ä½ ", "å¥½" (2)
        // è¿™æ¯”ç®€å•çš„ length è®¡ç®—æ›´æ¥è¿‘çœŸå® Token æ¶ˆè€—
        const matches = text.match(/[\w]+|[^\s\w]/g);
        return matches ? matches.length : 0;
      }

      // 2. ä¸¥æ ¼çš„ HTML æå–ä¸éªŒè¯
      function extractAndValidateHtml(rawText) {
        if (!rawText) return { html: null, isValid: false, truncated: false };

        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ <think> æ ‡ç­¾ (DeepSeek/Qwen ç­‰æ¨ç†æ¨¡å‹)
        const cleanText = rawText
          .replace(/<think>[\s\S]*?<\/think>/gi, "")
          .trim();

        let code = "";
        let isValid = false;
        let truncated = false;

        // ç­–ç•¥ A: ä¼˜å…ˆåŒ¹é… Markdown ä»£ç å— ```html ... ```
        // å¿…é¡»ä»¥ ``` ç»“å°¾æ‰ç®—å®Œæ•´
        const mdRegex = /```html\s*([\s\S]*?)```/i;
        const mdMatch = cleanText.match(mdRegex);

        if (mdMatch && mdMatch[1]) {
          code = mdMatch[1];
          isValid = true; // Markdown å®Œæ•´é—­åˆ
        } else {
          // å¦‚æœæ²¡æœ‰å®Œæ•´é—­åˆçš„ markdownï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯æˆªæ–­çš„ markdown
          const truncatedMdRegex = /```html\s*([\s\S]*)/i;
          const trMatch = cleanText.match(truncatedMdRegex);

          if (trMatch) {
            code = trMatch[1];
            truncated = true;
            isValid = false; // æˆªæ–­è§†ä¸ºæ— æ•ˆ
          } else {
            // ç­–ç•¥ B: ç›´æ¥å¯»æ‰¾ HTML æ ‡ç­¾ (é˜²æ­¢æ¨¡å‹æœªè¾“å‡º Markdown æ ‡è®°)
            const htmlTagRegex = /(<!DOCTYPE html>|<html)[\s\S]*/i;
            const tagMatch = cleanText.match(htmlTagRegex);

            if (tagMatch) {
              code = tagMatch[0];
              // æ£€æŸ¥æ˜¯å¦åŒ…å«é—­åˆæ ‡ç­¾
              if (/<\/html>\s*$/i.test(code) || /<\/body>\s*$/i.test(code)) {
                isValid = true;
              } else {
                truncated = true;
                isValid = false;
              }
            }
          }
        }
        return { html: code, isValid, truncated };
      }

      // 3. UI å…ƒç´ ç»Ÿè®¡ (ä½¿ç”¨ Virtual DOM)
      function analyzeUiElements(htmlCode) {
        if (!htmlCode)
          return { buttons: 0, inputs: 0, images: 0, links: 0, divs: 0 };

        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlCode, "text/html");

          return {
            // æŒ‰é’®ï¼šbutton æ ‡ç­¾ + input[type=button/submit]
            buttons: doc.querySelectorAll(
              'button, input[type="button"], input[type="submit"]'
            ).length,
            // è¾“å…¥æ¡†ï¼šinput (æ’é™¤ hidden/button) + textarea + select
            inputs: doc.querySelectorAll(
              'input:not([type="hidden"]):not([type="button"]):not([type="submit"]), textarea, select'
            ).length,
            images: doc.querySelectorAll("img").length,
            links: doc.querySelectorAll("a").length,
            divs: doc.querySelectorAll("div").length,
          };
        } catch (e) {
          return { buttons: 0, inputs: 0, images: 0, links: 0, divs: 0 };
        }
      }

      // HTML è½¬ä¹‰é˜²æ­¢ XSS å’Œæ˜¾ç¤ºé”™è¯¯
      function escapeHtml(unsafe) {
        if (typeof unsafe !== "string") return "";
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function escapeAttribute(unsafe) {
        if (!unsafe) return "";
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }
    </script>
  </body>
</html>
